<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>MTR_WEB – Experimental Index</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin:16px; }
    header { display:flex; flex-wrap:wrap; align-items:baseline; gap:12px; margin-bottom:12px; }
    .muted { color:#666; font-size:.95rem; }
    .toolbar{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; margin:8px 0 12px }
    .pill{ padding:6px 10px; border:1px solid #d1d5db; border-radius:999px; background:#fff; cursor:pointer }
    .pill.active{ background:#111827; color:#fff; border-color:#111827 }
    .btn{ padding:6px 10px; border:1px solid #d1d5db; border-radius:8px; background:#fff; cursor:pointer }
    .card{ border:1px solid #e5e7eb; border-radius:12px; padding:12px 14px; margin-bottom:16px; box-shadow:0 1px 2px rgba(0,0,0,.04) }
    table{ width:100%; border-collapse: collapse }
    th,td{ padding:6px 8px; border-bottom:1px solid #eee; text-align:left; font-size:.95rem }
    th{ background:#fafafa; position: sticky; top:0 }
    .error{ background:#fee2e2; color:#991b1b; border:1px solid #fecaca; padding:8px 10px; border-radius:8px; margin-bottom:12px; display:none }
  </style>
</head>
<body>
<header>
  <h1>MTR_WEB Experimental Dashboard</h1>
  <div class="muted">(index2.html – safe test page)</div>
</header>

<div id="error" class="error"></div>

<div class="card">
  <label for="ipSelect"><strong>Target:</strong></label>
  <select id="ipSelect"></select>
  <span class="muted" id="desc"></span>
</div>

<div class="card">
  <div class="toolbar" id="rangeBar">
    <strong>Time range:</strong>
    <span class="muted" id="last-update" style="margin-left:8px;"></span>
  </div>
  <div id="status-line"></div>
</div>

<div class="card">
  <h3>Latency over time</h3>
  <canvas id="latencyChart" height="200"></canvas>
</div>

<div class="card">
  <h3>Snapshot per hop</h3>
  <button class="btn" id="refreshSnapshot">Refresh snapshot</button>
  <canvas id="snapshotLatency" height="220"></canvas>
</div>

<div class="card">
  <h3>Traceroute</h3>
  <table id="trTable">
    <thead><tr><th>#</th><th>Hop</th><th>Hostname</th></tr></thead>
    <tbody></tbody>
  </table>
</div>

<script>
(async function(){
  const DATA_BASE  = 'data';      // /html/data/
  const TRACE_BASE = '../traces'; // /traces/

  const RANGES = ['15m','30m','1h','6h','12h','24h','2d','2w','1w','1M','2M','6M','1Y'];
  let TARGET_IP = new URLSearchParams(location.search).get('ip');
  let availableRanges = [];
  let currentRange = null;
  let latencyChart = null, snapshotChart = null;

  const ipSelect = document.getElementById('ipSelect');
  const trTableBody = document.querySelector('#trTable tbody');
  const statusLine = document.getElementById('status-line');
  const lastUpdateEl = document.getElementById('last-update');
  const errBox = document.getElementById('error');

  function showErr(msg){ console.error(msg); errBox.textContent = msg; errBox.style.display='block'; }
  function clearErr(){ errBox.style.display='none'; }

  function dataPath(ip,range){ return `${DATA_BASE}/${ip}_${range}.json`; }
  function hopsPath(ip){ return `${TRACE_BASE}/${ip}_hops.json`; }

  async function getJSON(url){
    const res = await fetch(url, {cache:'no-store'});
    if(!res.ok) throw new Error(`HTTP ${res.status} for ${url}`);
    return res.json();
  }

  function normalizeTimes(json){ return json.timestamps || json.times || json.labels || []; }
  function normalizeSeries(json){
    let arr = json.series || json.hops || [];
    return arr.map((s,idx)=>({
      hop: s.hop ?? idx,
      label: s.label || s.ip || s.addr || s.host || `hop${idx}`,
      avg: Array.isArray(s.avg)?s.avg:null,
      last:Array.isArray(s.last)?s.last:null
    }));
  }

  function extractSeries(json){
    const labels = normalizeTimes(json);
    const raw = normalizeSeries(json);
    return {labels, datasets: raw.map(s=>({
      label:`h${s.hop} ${s.label}`,
      data:s.avg || s.last || [],
      borderWidth:1, pointRadius:0, tension:0.2
    }))};
  }
  function extractSnapshot(json){
    const raw = normalizeSeries(json);
    return {
      labels: raw.map(s=>`h${s.hop} ${s.label}`),
      data: raw.map(s=>{
        const arr=s.avg||s.last||[]; return arr[arr.length-1]??null;
      })
    };
  }

  function renderLatencyChart(series){
    const ctx=document.getElementById('latencyChart').getContext('2d');
    if(latencyChart) latencyChart.destroy();
    latencyChart=new Chart(ctx,{type:'line',data:series,
      options:{animation:false,responsive:true,scales:{y:{beginAtZero:true}}}});
  }
  function renderSnapshotChart(snap){
    const ctx=document.getElementById('snapshotLatency').getContext('2d');
    if(snapshotChart) snapshotChart.destroy();
    snapshotChart=new Chart(ctx,{type:'bar',
      data:{labels:snap.labels,datasets:[{label:'latest avg (ms)',data:snap.data}]},
      options:{indexAxis:'y',responsive:true,scales:{x:{beginAtZero:true}}}});
  }

  function renderTraceroute(hops){
    trTableBody.innerHTML='';
    (hops.hops||hops||[]).forEach((h,i)=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${i}</td><td>${h.ip||''}</td><td>${h.hostname||''}</td>`;
      trTableBody.appendChild(tr);
    });
  }

  async function loadRange(ip,range){
    try{
      const json=await getJSON(dataPath(ip,range));
      renderLatencyChart(extractSeries(json));
      renderSnapshotChart(extractSnapshot(json));
      lastUpdateEl.textContent="updated "+new Date().toLocaleTimeString();
    }catch(e){ showErr(e.message); }
  }
  async function loadTraceroute(ip){
    try{ renderTraceroute(await getJSON(hopsPath(ip))); }catch(e){ console.warn("no hops",e); }
  }

  // --- Init ---
  if(!TARGET_IP){
    // Build dropdown from filenames in /html/data/ (requires directory listing enabled)
    // If Apache doesn't list JSON files, you can hardcode your IPs here instead.
    const resp=await fetch(DATA_BASE+"/");
    const text=await resp.text();
    const ips=[...text.matchAll(/([0-9.]+)_\d+[A-Za-z]+\.json/g)].map(m=>m[1]);
    const uniq=[...new Set(ips)];
    uniq.forEach(ip=>{
      const opt=document.createElement('option');
      opt.value=ip; opt.textContent=ip;
      ipSelect.appendChild(opt);
    });
    ipSelect.addEventListener('change',()=>{
      TARGET_IP=ipSelect.value; start();
    });
    if(uniq.length){ TARGET_IP=uniq[0]; ipSelect.value=TARGET_IP; }
  }else{
    ipSelect.innerHTML=`<option>${TARGET_IP}</option>`;
  }
  start();

  async function start(){
    if(!TARGET_IP) return;
    clearErr();
    // probe available ranges
    availableRanges=[];
    for(const r of RANGES){
      try{ await getJSON(dataPath(TARGET_IP,r)); availableRanges.push(r); }catch(_){}
    }
    if(!availableRanges.length){ showErr("No data files found for "+TARGET_IP); return; }
    currentRange=availableRanges[0];
    await loadRange(TARGET_IP,currentRange);
    await loadTraceroute(TARGET_IP);
    document.getElementById('refreshSnapshot').onclick=()=>loadRange(TARGET_IP,currentRange);
    const bar=document.getElementById('rangeBar');
    bar.querySelectorAll('.pill').forEach(b=>b.remove());
    availableRanges.forEach(r=>{
      const b=document.createElement('button');
      b.className='pill'+(r===currentRange?' active':'');
      b.textContent=r; b.onclick=()=>{currentRange=r;loadRange(TARGET_IP,r);};
      bar.appendChild(b);
    });
  }
})();
</script>
</body>
</html>
